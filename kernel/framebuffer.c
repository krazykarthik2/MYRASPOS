#include "framebuffer.h"
#include "virtio.h"
#include <stdint.h>
#include <stddef.h>

static volatile uint32_t *fb = NULL;
static int fb_w = 0;
static int fb_h = 0;
static int fb_stride = 0; /* in pixels (not bytes) */
static int fb_init_done = 0;

/* Simple 5x7 block glyphs for a small character set used in the splash */
struct glyph5x7 { char ch; uint8_t rows[7]; };

static const struct glyph5x7 glyphs[] = {
    {'A', {0x0E,0x11,0x11,0x1F,0x11,0x11,0x11}},
    {'B', {0x1E,0x11,0x11,0x1E,0x11,0x11,0x1E}},
    {'C', {0x0E,0x11,0x10,0x10,0x10,0x11,0x0E}},
    {'D', {0x1E,0x11,0x11,0x11,0x11,0x11,0x1E}},
    {'E', {0x1F,0x10,0x10,0x1E,0x10,0x10,0x1F}},
    {'F', {0x1F,0x10,0x10,0x1E,0x10,0x10,0x10}},
    {'G', {0x0E,0x11,0x10,0x13,0x11,0x11,0x0E}},
    {'H', {0x11,0x11,0x11,0x1F,0x11,0x11,0x11}},
    {'I', {0x0E,0x04,0x04,0x04,0x04,0x04,0x0E}},
    {'J', {0x07,0x02,0x02,0x02,0x02,0x12,0x0C}},
    {'K', {0x11,0x12,0x14,0x18,0x14,0x12,0x11}},
    {'L', {0x10,0x10,0x10,0x10,0x10,0x10,0x1F}},
    {'M', {0x11,0x1B,0x15,0x11,0x11,0x11,0x11}},
    {'N', {0x11,0x11,0x19,0x15,0x13,0x11,0x11}},
    {'O', {0x0E,0x11,0x11,0x11,0x11,0x11,0x0E}},
    {'P', {0x1E,0x11,0x11,0x1E,0x10,0x10,0x10}},
    {'Q', {0x0E,0x11,0x11,0x11,0x15,0x12,0x0D}},
    {'R', {0x1E,0x11,0x11,0x1E,0x14,0x12,0x11}},
    {'S', {0x0F,0x10,0x10,0x0E,0x01,0x01,0x1E}},
    {'T', {0x1F,0x04,0x04,0x04,0x04,0x04,0x04}},
    {'U', {0x11,0x11,0x11,0x11,0x11,0x11,0x0E}},
    {'V', {0x11,0x11,0x11,0x11,0x11,0x0A,0x04}},
    {'W', {0x11,0x11,0x11,0x15,0x15,0x1B,0x11}},
    {'X', {0x11,0x11,0x0A,0x04,0x0A,0x11,0x11}},
    {'Y', {0x11,0x11,0x0A,0x04,0x04,0x04,0x04}},
    {'Z', {0x1F,0x01,0x02,0x04,0x08,0x10,0x1F}},
    {'0', {0x0E,0x11,0x19,0x15,0x13,0x11,0x0E}},
    {'1', {0x04,0x0C,0x04,0x04,0x04,0x04,0x0E}},
    {'2', {0x0E,0x11,0x01,0x02,0x04,0x08,0x1F}},
    {'3', {0x1F,0x02,0x04,0x02,0x01,0x11,0x0E}},
    {'4', {0x02,0x06,0x0A,0x12,0x1F,0x02,0x02}},
    {'5', {0x1F,0x10,0x1E,0x01,0x01,0x11,0x0E}},
    {'6', {0x06,0x08,0x1E,0x11,0x11,0x11,0x0E}},
    {'7', {0x1F,0x01,0x02,0x04,0x04,0x04,0x04}},
    {'8', {0x0E,0x11,0x11,0x0E,0x11,0x11,0x0E}},
    {'9', {0x0E,0x11,0x11,0x0F,0x01,0x02,0x0C}},
    {'.', {0x00,0x00,0x00,0x00,0x00,0x00,0x04}},
    {':', {0x00,0x04,0x00,0x00,0x00,0x04,0x00}},
    {'/', {0x01,0x02,0x04,0x08,0x10,0x20,0x00}},
    {'-', {0x00,0x00,0x00,0x1F,0x00,0x00,0x00}},
    {'_', {0x00,0x00,0x00,0x00,0x00,0x00,0x1F}},
    {'(', {0x02,0x04,0x08,0x08,0x08,0x04,0x02}},
    {')', {0x08,0x04,0x02,0x02,0x02,0x04,0x08}},
    {'[', {0x0E,0x08,0x08,0x08,0x08,0x08,0x0E}},
    {']', {0x0E,0x02,0x02,0x02,0x02,0x02,0x0E}},
    {'$', {0x04,0x0F,0x14,0x0E,0x05,0x1E,0x04}},
    {'!', {0x04,0x04,0x04,0x04,0x04,0x00,0x04}},
    {'>', {0x10,0x08,0x04,0x02,0x04,0x08,0x10}},
    {'<', {0x02,0x04,0x08,0x10,0x08,0x04,0x02}},
    {'|', {0x04,0x04,0x04,0x00,0x04,0x04,0x04}},
    {' ', {0x00,0x00,0x00,0x00,0x00,0x00,0x00}},
};

static const uint8_t *get_glyph(char c) {
    if (c >= 'a' && c <= 'z') c = (char)(c - 'a' + 'A');
    for (size_t i = 0; i < sizeof(glyphs)/sizeof(glyphs[0]); ++i) {
        if (glyphs[i].ch == c) return glyphs[i].rows;
    }
    /* fallback: space (mapping ' ' to empty pixels) */
    return glyphs[50].rows;
}

void fb_init(void *addr, int width, int height, int stride_bytes) {
    fb = (volatile uint32_t *)addr;
    fb_w = width;
    fb_h = height;
    fb_stride = stride_bytes / 4;
    fb_fill(0x000000); /* Mandatory clear */
    fb_init_done = 1;
}

int fb_is_init(void) { return fb_init_done; }

void fb_fill(uint32_t color) {
    if (!fb) return;
    for (int y = 0; y < fb_h; ++y) {
        volatile uint32_t *row = fb + (y * fb_stride);
        for (int x = 0; x < fb_w; ++x) row[x] = color;
    }
    virtio_gpu_flush();
}

static void fb_set_pixel(int x, int y, uint32_t color) {
    if (!fb) return;
    if (x < 0 || x >= fb_w || y < 0 || y >= fb_h) return;
    fb[y * fb_stride + x] = color;
}

static void fb_draw_scaled_glyph(const uint8_t *g, int x, int y, int scale, uint32_t color) {
    /* glyph is 5 cols (bits 0..4), 7 rows */
    for (int row = 0; row < 7; ++row) {
        uint8_t bits = g[row];
        for (int col = 0; col < 5; ++col) {
            int bit = (bits >> (4 - col)) & 1;
            if (bit) {
                /* draw scaled rectangle */
                int sx = x + col*scale;
                int sy = y + row*scale;
                for (int yy = 0; yy < scale; ++yy) {
                    for (int xx = 0; xx < scale; ++xx) {
                        fb_set_pixel(sx + xx, sy + yy, color);
                    }
                }
            }
        }
    }
}

void fb_put_text_centered(const char *s, uint32_t color) {
    if (!fb) return;
    /* compute text pixel width using scale */
    int len = 0; while (s[len]) len++;
    int glyph_w = 5; int glyph_h = 7; int scale = 8; int spacing = scale; /* pixels between glyphs */
    int total_w = len * (glyph_w * scale) + (len - 1) * spacing;
    int start_x = (fb_w - total_w) / 2;
    int start_y = (fb_h - (glyph_h * scale)) / 2;
    int x = start_x;
    for (int i = 0; i < len; ++i) {
        const uint8_t *g = get_glyph(s[i]);
        fb_draw_scaled_glyph(g, x, start_y, scale, color);
        x += glyph_w * scale + spacing;
    }
    virtio_gpu_flush();
}

/* simple terminal at top-left using same 5x7 glyphs scaled small */
static int term_x = 0, term_y = 0;
static const int term_scale = 2;
static const int term_cols = 70; /* 70 chars * 11px = 770px < 800px */
static const int term_rows = 35; /* 35 lines * 15px = 525px < 600px */

void fb_puts(const char *s) {
    if (!fb) return;
    while (*s) {
        char c = *s++;
        if (c == '\n') {
            term_x = 0; term_y++;
            if (term_y >= term_rows) {
                /* simple scroll: clear and reset */
                fb_fill(0x000000);
                term_y = 0;
            }
            continue;
        }
        if (c < 32) continue;
        int px = term_x * (5 * term_scale + 1);
        int py = term_y * (7 * term_scale + 1);
        /* clear background for this char */
        for (int ty = 0; ty < 7 * term_scale + 1; ++ty) {
            for (int tx = 0; tx < 5 * term_scale + 1; ++tx) {
                fb_set_pixel(px + tx, py + ty, 0x000000);
            }
        }
        const uint8_t *g = get_glyph(c);
        fb_draw_scaled_glyph(g, px, py, term_scale, 0xFFFFFFFF);
        term_x++;
        if (term_x >= term_cols) { term_x = 0; term_y++; }
        if (term_y >= term_rows) { fb_fill(0x000000); term_y = 0; }
    }
    virtio_gpu_flush();
}
